<!DOCTYPE html>
<html>
<head>
  <title>Demo : GCM for Chrome</title>
  <link rel="manifest" href="./manifest.json">
</head>
<body>
<header>
  <h1>Demo : GCM for Chrome</h1>
</header>
<section>
  <label>email</label><input id="email" type="text"/><br/>
  <label>password</label><input id="pass" type="password"/><br/>
  <button onclick="signup()">Sign up</button></br>
  <button onclick="login()">Log in</button></br>
</section>

<script src="https://code.jquery.com/jquery-1.9.0.min.js"></script>
<script src="./KiiLib-jQuery.js"></script>
<script src="../bin/GCMClientImpl.js"></script>
<script type="text/javascript">
var client = new GCMClientImpl();
var app = {
  token : null
};

window.addEventListener('load', function () {
  if (!client.isServiceWorkerEnabled()) {
    console.log('Service worker is disabled...');
    return;
  }
  if (!client.isNotificationEnabled()) {
    console.log('Notification is disabled...');
    return;
  }
  navigator.serviceWorker.register('./service-worker.js')  
    .then(initialiseState);  
});

function initialiseState() {
  client.getSubscription({
    success : function(token) {
      app.token = token;
      console.log('token=' + token);
    },
    error : function(err) {
      console.log('failed to get subscription ' + err);
    }
  });
}

function subscribe() {
  return new Promise(function(resolve, reject){
    client.subscribe({
      success : function(token) {
        console.log('token=' + token);
        app.token = token;
        resolve();
      },
      error : function(err) {
        console.log('failed to subscribe ' + err);
        reject();
      }
    });
  });
}

/**
 * Kii Cloud related functions
 */
var context = new Kii.KiiContext('f77252ad', '47d9cc792acfd1316e5d1300fe206cda', 'https://api-jp.kii.com/api');
var api = new Kii.KiiAppAPI(context);

function signup() {
  var email = $('#email').val();
  var password = $('#pass').val();
  var params = {
    emailAddress : email
  };
  signupAsync(email, password)
  .then(function(){ return loginAsync(email, password);});
}

function login() {
  var email = $('#email').val();
  var password = $('#pass').val();

  if (app.token == null) {
    loginAsync(email, password)
      .then(subscribe)
      .then(installDevice);
  } else {
    loginAsync(email, password)
      .then(subscribe)
      .then(installDevice)
      .then(function(){ console.log('Done'); });
  }
}

function signupAsync(email, password) {
  return new Promise(function(resolve, reject){
    var params = {
      emailAddress : email
    };
    api.signUp(params, password, {
      success : function(user) {
        resolve();
      },
      error : function(status, msg) {
        console.log('Failed to signup status=' + status + ' msg=' + msg);
        reject();
      }
    });
  });
}

function loginAsync(email, password) {
  return new Promise(function(resolve, reject){
    api.login(email, password, {
      success : function(user) {
        console.log(context);
        resolve();
      },
      error : function(status, msg) {
        console.log('Failed to login status=' + status + ' msg=' + msg);
        reject();
      }
    });
  });
}

function installDevice() {
  return new Promise(function(resolve, reject){
    console.log(context);
    api.userAPI().installDevice(null, 'ANDROID', app.token, false, {
      success : function() {
        resolve();
      },
      error : function(status, msg) {
        console.log('Failed to install device status=' + status + ' msg=' + msg);
        reject();
      }
    });
  });
}


</script>
</body>
</html>
